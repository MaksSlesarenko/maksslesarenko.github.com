\hypertarget{Manager_8php}{\section{Manager.\-php}
\label{Manager_8php}\index{Db/\-Migration/\-Manager.\-php@{Db/\-Migration/\-Manager.\-php}}
}

\begin{DoxyCode}
00001 <?php
\hypertarget{Manager_8php_source_l00029}{}\hyperlink{classZendDbSchema__Db__Migration__Manager}{00029} \textcolor{keyword}{class }\hyperlink{classZendDbSchema__Db__Migration__Manager}{ZendDbSchema\_Db\_Migration\_Manager} \textcolor{keyword}{
      implements} IteratorAggregate
00030 \{
00034     \textcolor{keyword}{protected} $\_adapter;
00035 
00039     \textcolor{keyword}{protected} $\_changes = array();
00040 
00041     \textcolor{keyword}{protected} $\_currentVersion;
00042 
\hypertarget{Manager_8php_source_l00049}{}\hyperlink{classZendDbSchema__Db__Migration__Manager_a5bc6e13f1d6ae95a759178d5342aa6ca}{00049}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Db__Migration__Manager_a5bc6e13f1d6ae95a759178d5342aa6ca}{\_\_construct}($version, array $files = array(), 
      array $options = array())
00050     \{
00051         $this->\_currentVersion = (string) $version;
00052 
00053         \textcolor{keywordflow}{foreach} ($files as $file) \{
00054             $this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a2450580273691865299544ba500e01b2}{addChange}($file);
00055         \}
00056 
00057         \textcolor{keywordflow}{if} (empty($options[\textcolor{stringliteral}{'directory'}])) \{
00058             \textcolor{keywordflow}{foreach} (\textcolor{keyword}{new} DirectoryIterator($options[\textcolor{stringliteral}{'directory'}]) as $file) \{
00059                 \textcolor{keywordflow}{if} ($file->isFile() && substr($file->getBasename(), -4) == \textcolor{stringliteral}{'
      .php'}) \{
00060                     $this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a2450580273691865299544ba500e01b2}{addChange}($file);
00061                 \}
00062             \}
00063         \}
00064 
00065         \textcolor{keywordflow}{if} ($this->\_currentVersion && !array\_key\_exists($this->\_currentVersion,
       $this->\_changes)) \{
00066             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} \hyperlink{classZendDbSchema__Db__Migration__Exception}{ZendDbSchema\_Db\_Migration\_Exception}
      (
00067                 \textcolor{stringliteral}{"Current change '\{$this->\_currentVersion\}' in not exists"}
00068             );
00069         \}
00070 
00071         $prev = null;
00072         \textcolor{keywordflow}{foreach} ($this->\_changes as $version => $instance) \{
00073             $this->\_changes[$version][\textcolor{stringliteral}{'previous'}] = $prev;
00074             \textcolor{keywordflow}{if} ($prev) \{
00075                 $this->\_changes[$prev][\textcolor{stringliteral}{'next'}] = $version;
00076             \}
00077             $prev = $version;
00078         \}
00079 
00080         $this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a0bf69842e44f9aa3a736deb020f0f1fa}{init}();
00081     \}
00082 
\hypertarget{Manager_8php_source_l00089}{}\hyperlink{classZendDbSchema__Db__Migration__Manager_a2450580273691865299544ba500e01b2}{00089}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Db__Migration__Manager_a2450580273691865299544ba500e01b2}{addChange}($change)
00090     \{
00091         \textcolor{keywordflow}{if} (!$change instanceof \hyperlink{classZendDbSchema__Db__Migration__Change}{ZendDbSchema\_Db\_Migration\_Change}
      ) \{
00092             $change = \hyperlink{classZendDbSchema__Db__Migration__Change_abd5253380521e63e91099a6ab3b89387}{ZendDbSchema\_Db\_Migration\_Change::fromFile}
      ($change);
00093         \}
00094         $this->\_changes[$change->getVersion()] = array(\textcolor{stringliteral}{'instance'} => $change);
00095 
00096         \textcolor{keywordflow}{foreach} ($this->\_changes as $change) \{
00097             \textcolor{keywordflow}{if} ($change->compareVersion($change, \textcolor{charliteral}{'='})) \{
00098                 \textcolor{keywordflow}{break};
00099             \}
00100         \}
00101         $next = next($this->\_changes);
00102         $this->\_changes[$change->getVersion()][\textcolor{stringliteral}{'next'}] = key($next);
00103 
00104         $prev = prev(prev($this->\_changes));
00105 
00106         $this->\_changes[$prev][\textcolor{stringliteral}{'next'}] = $change->getVersion();
00107 
00108         \textcolor{keywordflow}{return} $this;
00109     \}
00110 
\hypertarget{Manager_8php_source_l00114}{}\hyperlink{classZendDbSchema__Db__Migration__Manager_a0bf69842e44f9aa3a736deb020f0f1fa}{00114}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Db__Migration__Manager_a0bf69842e44f9aa3a736deb020f0f1fa}{init}()
00115     \{
00116     \}
00117 
\hypertarget{Manager_8php_source_l00123}{}\hyperlink{classZendDbSchema__Db__Migration__Manager_a09b440110f77079a37794ccdb0922d41}{00123}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Db__Migration__Manager_a09b440110f77079a37794ccdb0922d41}{getIterator}()
00124     \{
00125         ksort($this->\_changes);
00126 
00127         \textcolor{keywordflow}{return} $this->\_changes;
00128     \}
00129 
\hypertarget{Manager_8php_source_l00135}{}\hyperlink{classZendDbSchema__Db__Migration__Manager_a45f1f55c26694ff5fb0806e4547a3dc8}{00135}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Db__Migration__Manager_a45f1f55c26694ff5fb0806e4547a3dc8}{getList}()
00136     \{
00137         \textcolor{keywordflow}{return} array\_keys($this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a09b440110f77079a37794ccdb0922d41}{getIterator}());
00138     \}
00139 
\hypertarget{Manager_8php_source_l00145}{}\hyperlink{classZendDbSchema__Db__Migration__Manager_ab66af8a9dc5cdb099b8266b68166c4e0}{00145}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Db__Migration__Manager_ab66af8a9dc5cdb099b8266b68166c4e0}{getVersion}()
00146     \{
00147         \textcolor{keywordflow}{return} $this->\_currentVersion;
00148     \}
00149 
\hypertarget{Manager_8php_source_l00156}{}\hyperlink{classZendDbSchema__Db__Migration__Manager_a3d4f62489e72876f97bec3cd4448979d}{00156}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Db__Migration__Manager_a3d4f62489e72876f97bec3cd4448979d}{getChange}($version = null)
00157     \{
00158         \textcolor{keywordflow}{if} (!$version) \{
00159             $version = $this->\hyperlink{classZendDbSchema__Db__Migration__Manager_ab66af8a9dc5cdb099b8266b68166c4e0}{getVersion}();
00160         \}
00161 
00162         \textcolor{keywordflow}{if} ($this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a9973d07f9ffe306e00ea2f9f4beb92e4}{hasChange}($version)) \{
00163             \textcolor{keywordflow}{return} $this->\_changes[$version][\textcolor{stringliteral}{'instance'}];
00164         \}
00165         \textcolor{keywordflow}{return} null;
00166     \}
00167 
\hypertarget{Manager_8php_source_l00174}{}\hyperlink{classZendDbSchema__Db__Migration__Manager_acb171835d37a1596a4ac6db273bf07ae}{00174}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Db__Migration__Manager_acb171835d37a1596a4ac6db273bf07ae}{getNext}($version = null)
00175     \{
00176         \textcolor{keywordflow}{if} (!$version) \{
00177             $version = $this->\hyperlink{classZendDbSchema__Db__Migration__Manager_ab66af8a9dc5cdb099b8266b68166c4e0}{getVersion}();
00178         \}
00179         \textcolor{keywordflow}{if} ($this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a9973d07f9ffe306e00ea2f9f4beb92e4}{hasChange}($version)) \{
00180             \textcolor{keywordflow}{return} $this->\_changes[$version][\textcolor{stringliteral}{'next'}];
00181         \}
00182         \textcolor{keywordflow}{return} key($this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a09b440110f77079a37794ccdb0922d41}{getIterator}());
00183     \}
00184 
\hypertarget{Manager_8php_source_l00191}{}\hyperlink{classZendDbSchema__Db__Migration__Manager_a9973d07f9ffe306e00ea2f9f4beb92e4}{00191}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Db__Migration__Manager_a9973d07f9ffe306e00ea2f9f4beb92e4}{hasChange}($change)
00192     \{
00193         \textcolor{keywordflow}{return} array\_key\_exists((\textcolor{keywordtype}{string}) $change, $this->\_changes);
00194     \}
00195 
\hypertarget{Manager_8php_source_l00202}{}\hyperlink{classZendDbSchema__Db__Migration__Manager_a3e9a5dfa3447c5eb1b4bbcc8817549c3}{00202}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Db__Migration__Manager_a3e9a5dfa3447c5eb1b4bbcc8817549c3}{getPrevious}($version = null)
00203     \{
00204         \textcolor{keywordflow}{if} (!$version) \{
00205             $version = $this->\hyperlink{classZendDbSchema__Db__Migration__Manager_ab66af8a9dc5cdb099b8266b68166c4e0}{getVersion}();
00206         \}
00207         \textcolor{keywordflow}{if} ($this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a9973d07f9ffe306e00ea2f9f4beb92e4}{hasChange}($version)) \{
00208             \textcolor{keywordflow}{return} $this->\_changes[$version][\textcolor{stringliteral}{'prev'}];
00209         \}
00210         \textcolor{keywordflow}{return} null;
00211     \}
00212 
\hypertarget{Manager_8php_source_l00217}{}\hyperlink{classZendDbSchema__Db__Migration__Manager_afbaee9196407b68350626e8601a44a9a}{00217}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Db__Migration__Manager_afbaee9196407b68350626e8601a44a9a}{rollup}()
00218     \{
00219         $next = $this->\hyperlink{classZendDbSchema__Db__Migration__Manager_acb171835d37a1596a4ac6db273bf07ae}{getNext}();
00220         \textcolor{keywordflow}{if} (!$next) \{
00221             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} \hyperlink{classZendDbSchema__Db__Migration__Exception}{ZendDbSchema\_Db\_Migration\_Exception}
      (\textcolor{stringliteral}{'No migration to rollup'});
00222         \}
00223 
00224         $change = $this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a3d4f62489e72876f97bec3cd4448979d}{getChange}($next);
00225         \textcolor{keywordflow}{foreach} ($change->getTablesConfig() as $name => $config) \{
00226             $schema = \textcolor{keyword}{new} \hyperlink{classZendDbSchema__Db__Schema__Table}{ZendDbSchema\_Db\_Schema\_Table}
      ($name);
00227             $schema->setFromArray($config);
00228             $schema->save();
00229         \}
00230         $change->up();
00231 
00232         $this->\_currentVersion = $next;
00233     \}
00234 
\hypertarget{Manager_8php_source_l00239}{}\hyperlink{classZendDbSchema__Db__Migration__Manager_a3acd09811b23c39aa97fed97b4012ac9}{00239}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Db__Migration__Manager_a3acd09811b23c39aa97fed97b4012ac9}{rolldown}()
00240     \{
00241         \textcolor{keywordflow}{if} (!$this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a3d4f62489e72876f97bec3cd4448979d}{getChange}()) \{
00242             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} \hyperlink{classZendDbSchema__Db__Migration__Exception}{ZendDbSchema\_Db\_Migration\_Exception}
      (\textcolor{stringliteral}{'No migration to rolldown'});
00243         \}
00244         $prev = $this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a3e9a5dfa3447c5eb1b4bbcc8817549c3}{getPrevious}();
00245         \textcolor{keywordflow}{if} (!$prev) \{
00246             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} \hyperlink{classZendDbSchema__Db__Migration__Exception}{ZendDbSchema\_Db\_Migration\_Exception}
      (\textcolor{stringliteral}{'Current migration is initial'});
00247         \}
00248 
00249         \textcolor{keywordflow}{if} (!$this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a3d4f62489e72876f97bec3cd4448979d}{getChange}()->isDowngradable()) \{
00250             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} \hyperlink{classZendDbSchema__Db__Migration__Exception}{ZendDbSchema\_Db\_Migration\_Exception}
      ($this->\hyperlink{classZendDbSchema__Db__Migration__Manager_ab66af8a9dc5cdb099b8266b68166c4e0}{getVersion}() . \textcolor{stringliteral}{' migration is not downgradable'});
00251         \}
00252 
00253         $change = $this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a3d4f62489e72876f97bec3cd4448979d}{getChange}($prev);
00254         \textcolor{keywordflow}{foreach} ($change->getTablesConfig() as $name => $config) \{
00255             $schema = \textcolor{keyword}{new} \hyperlink{classZendDbSchema__Db__Schema__Table}{ZendDbSchema\_Db\_Schema\_Table}
      ($name);
00256             $schema->setFromArray($config);
00257             $schema->save();
00258         \}
00259         $change->down();
00260 
00261         $this->\_currentVersion = $prev;
00262     \}
00263 
\hypertarget{Manager_8php_source_l00270}{}\hyperlink{classZendDbSchema__Db__Migration__Manager_a260901608e7ed2fb5ffef1bf8387e2e9}{00270}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Db__Migration__Manager_a260901608e7ed2fb5ffef1bf8387e2e9}{up}($version = null)
00271     \{
00272         \textcolor{keywordflow}{if} ($this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a3f8150b5e2fc90623a10c7890af80185}{compareVersion}($version, \textcolor{charliteral}{'='})) \{
00273             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} \hyperlink{classZendDbSchema__Db__Migration__Exception}{ZendDbSchema\_Db\_Migration\_Exception}
      (\textcolor{stringliteral}{"Nothing to migrate"});
00274         \}
00275         \textcolor{keywordflow}{if} ($this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a3f8150b5e2fc90623a10c7890af80185}{compareVersion}($version, \textcolor{charliteral}{'<'})) \{
00276             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} \hyperlink{classZendDbSchema__Db__Migration__Exception}{ZendDbSchema\_Db\_Migration\_Exception}
      (\textcolor{stringliteral}{"'\{$version\}' is less then current"});
00277         \}
00278 
00279         \textcolor{keywordflow}{while} ($this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a3f8150b5e2fc90623a10c7890af80185}{compareVersion}($version, \textcolor{charliteral}{'>'})) \{
00280             $this->\hyperlink{classZendDbSchema__Db__Migration__Manager_afbaee9196407b68350626e8601a44a9a}{rollup}();
00281         \}
00282     \}
00283 
\hypertarget{Manager_8php_source_l00290}{}\hyperlink{classZendDbSchema__Db__Migration__Manager_a265c3edbe064cb4a34289b505046768a}{00290}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Db__Migration__Manager_a265c3edbe064cb4a34289b505046768a}{down}($version)
00291     \{
00292         \textcolor{keywordflow}{if} ($this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a3f8150b5e2fc90623a10c7890af80185}{compareVersion}($version, \textcolor{charliteral}{'='})) \{
00293             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} \hyperlink{classZendDbSchema__Db__Migration__Exception}{ZendDbSchema\_Db\_Migration\_Exception}
      (\textcolor{stringliteral}{"Nothing to migrate"});
00294         \}
00295         \textcolor{keywordflow}{if} ($this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a3f8150b5e2fc90623a10c7890af80185}{compareVersion}($version, \textcolor{charliteral}{'>'})) \{
00296             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} \hyperlink{classZendDbSchema__Db__Migration__Exception}{ZendDbSchema\_Db\_Migration\_Exception}
      (\textcolor{stringliteral}{"'\{$version\}' is greater then current"});
00297         \}
00298 
00299         \textcolor{keywordflow}{while} ($this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a3f8150b5e2fc90623a10c7890af80185}{compareVersion}($version, \textcolor{charliteral}{'<'})) \{
00300             $this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a3acd09811b23c39aa97fed97b4012ac9}{rolldown}();
00301         \}
00302     \}
00303 
\hypertarget{Manager_8php_source_l00312}{}\hyperlink{classZendDbSchema__Db__Migration__Manager_a3f8150b5e2fc90623a10c7890af80185}{00312}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Db__Migration__Manager_a3f8150b5e2fc90623a10c7890af80185}{compareVersion}($change, $operator = null)
00313     \{
00314         \textcolor{keywordflow}{if} (!$this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a9973d07f9ffe306e00ea2f9f4beb92e4}{hasChange}($change)) \{
00315             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} \hyperlink{classZendDbSchema__Db__Migration__Exception}{ZendDbSchema\_Db\_Migration\_Exception}
      (\textcolor{stringliteral}{"Change '\{$change\}' is not found"});
00316         \}
00317         \textcolor{keywordflow}{if} (!$change instanceof \hyperlink{classZendDbSchema__Db__Migration__Change}{ZendDbSchema\_Db\_Migration\_Change}
      ) \{
00318             $change = $this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a3d4f62489e72876f97bec3cd4448979d}{getChange}($change);
00319         \}
00320 
00321         $result = $change->compareVersion($this->\hyperlink{classZendDbSchema__Db__Migration__Manager_ab66af8a9dc5cdb099b8266b68166c4e0}{getVersion}(), 
      $operator);
00322 
00323         \textcolor{keywordflow}{return} is\_bool($result) ? !$result : -$result;
00324     \}
00325 
\hypertarget{Manager_8php_source_l00331}{}\hyperlink{classZendDbSchema__Db__Migration__Manager_a87a8f6699a75e4b89a0657ae0999203b}{00331}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Db__Migration__Manager_a87a8f6699a75e4b89a0657ae0999203b}{isDirty}()
00332     \{
00333         $change = $this->\hyperlink{classZendDbSchema__Db__Migration__Manager_a3d4f62489e72876f97bec3cd4448979d}{getChange}();
00334 
00335         \textcolor{keywordflow}{foreach} ($change->getTablesConfig() as $name => $config) \{
00336             $schema = \textcolor{keyword}{new} \hyperlink{classZendDbSchema__Db__Schema__Table}{ZendDbSchema\_Db\_Schema\_Table}
      ($name);
00337             $schema->setFromArray($config);
00338             \textcolor{keywordflow}{if} ($schema->isDirty()) \{
00339                 \textcolor{keywordflow}{return} \textcolor{keyword}{true};
00340             \}
00341         \}
00342 
00343         \textcolor{keywordflow}{foreach} ($change->getDatabasesConfig() as $name => $config) \{
00344             $schema = \textcolor{keyword}{new} \hyperlink{classZendDbSchema__Db__Schema__Table}{ZendDbSchema\_Db\_Schema\_Table}
      ($name);
00345             $schema->setFromArray($config);
00346             \textcolor{keywordflow}{if} ($schema->isDirty()) \{
00347                 \textcolor{keywordflow}{return} \textcolor{keyword}{true};
00348             \}
00349         \}
00350         \textcolor{keywordflow}{return} \textcolor{keyword}{false};
00351     \}
00352 \}
\end{DoxyCode}
