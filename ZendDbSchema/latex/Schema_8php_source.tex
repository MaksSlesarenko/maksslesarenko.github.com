\hypertarget{Schema_8php}{\section{Schema.\-php}
\label{Schema_8php}\index{Tool/\-Project/\-Provider/\-Schema.\-php@{Tool/\-Project/\-Provider/\-Schema.\-php}}
}

\begin{DoxyCode}
00001 <?php
\hypertarget{Schema_8php_source_l00029}{}\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema}{00029} \textcolor{keyword}{class }\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema}{ZendDbSchema\_Tool\_Project\_Provider\_Schema}
00030     \textcolor{keyword}{extends} Zend\_Tool\_Project\_Provider\_Abstract
00031     implements Zend\_Tool\_Framework\_Provider\_Pretendable
00032 \{
\hypertarget{Schema_8php_source_l00046}{}\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_ae23994cc878a689226c458de95a7ecd1}{00046}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_ae23994cc878a689226c458de95a7ecd1}{createResource}(Zend\_Tool\_Project\_Profile 
      $profile, $schemaName, $contents, $force = \textcolor{keyword}{false})
00047     \{
00048         \textcolor{keywordflow}{if} (!is\_string($schemaName)) \{
00049             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Zend\_Tool\_Project\_Provider\_Exception(
00050                 \textcolor{stringliteral}{'schema name must be a string'}
00051             );
00052         \}
00053 
00054         \textcolor{keywordflow}{if} ($this->\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_a4bab978eff99970636ddf863266e9d96}{\_findfile}($profile, $schemaName) !== \textcolor{keyword}{false} && 
      $force == \textcolor{keyword}{false}) \{
00055             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Zend\_Tool\_Project\_Provider\_Exception(
00056                 \textcolor{stringliteral}{'File named '} . $schemaName. \textcolor{stringliteral}{' already exists within the models
       directory.'}
00057             );
00058         \}
00059 
00060         $newFile = $profile->createResourceAt(
00061             \textcolor{stringliteral}{'schemaDirectory'},                  \textcolor{comment}{// where to create at}
00062             \textcolor{stringliteral}{'file'},                        \textcolor{comment}{// what to create}
00063             array(
00064                 \textcolor{stringliteral}{'schemaName'} => $schemaName,
00065                 \textcolor{stringliteral}{'fileContents'} => $contents)    \textcolor{comment}{// attrs to initiate with}
00066         );
00067 
00068         \textcolor{keywordflow}{return} $newFile;
00069     \}
00070 
\hypertarget{Schema_8php_source_l00077}{}\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_a785beba0921fd9df3111a88499406d64}{00077}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_a785beba0921fd9df3111a88499406d64}{getContextClasses}()
00078     \{
00079         \textcolor{keywordflow}{return} array(
00080             \textcolor{stringliteral}{'ZendDbSchema\_Tool\_Project\_Context\_Schema\_File'},
00081             \textcolor{stringliteral}{'ZendDbSchema\_Tool\_Project\_Context\_Schema\_Directory'}
00082         );
00083     \}
00084 
\hypertarget{Schema_8php_source_l00092}{}\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_a4bab978eff99970636ddf863266e9d96}{00092}     \textcolor{keyword}{protected} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_a4bab978eff99970636ddf863266e9d96}{\_findfile}($profile, $name)
00093     \{
00094         \textcolor{comment}{// check to see if a model already exists}
00095         $existingFile = $profile->search(array(
00096             \textcolor{stringliteral}{'schemaDirectory'},
00097             \textcolor{stringliteral}{'file'} => array(\textcolor{stringliteral}{'filesystemName'} => $name))
00098         );
00099         \textcolor{keywordflow}{return} $existingFile;
00100     \}
00101 
00102 
\hypertarget{Schema_8php_source_l00111}{}\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_ae00f032a9818a3227d29bde827856256}{00111}     \textcolor{keyword}{protected} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_ae00f032a9818a3227d29bde827856256}{\_getSchema}($type, $name)
00112     \{
00113         \textcolor{keywordflow}{if} (empty($name)) \{
00114             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Zend\_Tool\_Project\_Provider\_Exception(\textcolor{stringliteral}{'Schema name must
       not be empty'});
00115         \}
00116 
00117         \textcolor{keywordflow}{switch} ($type) \{
00118             \textcolor{keywordflow}{case} \textcolor{stringliteral}{'table'}:
00119                 $schema = \textcolor{keyword}{new} \hyperlink{classZendDbSchema__Db__Schema__Table}{ZendDbSchema\_Db\_Schema\_Table}
      ($name);
00120                 \textcolor{keywordflow}{break};
00121             \textcolor{keywordflow}{case} \textcolor{stringliteral}{'database'}:
00122                 $schema = \textcolor{keyword}{new} \hyperlink{classZendDbSchema__Db__Schema__Database}{ZendDbSchema\_Db\_Schema\_Database}
      ($name);
00123                 \textcolor{keywordflow}{break};
00124             \textcolor{keywordflow}{default}:
00125                 \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Zend\_Tool\_Project\_Provider\_Exception(
00126                     \textcolor{stringliteral}{"Type must be table or database, '\{$type\}' is given."}
00127                 );
00128         \}
00129         \textcolor{keywordflow}{return} $schema;
00130     \}
00131 
\hypertarget{Schema_8php_source_l00139}{}\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_a5f0f3101bb7b9e252f6d6bed1ddadbe5}{00139}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_a5f0f3101bb7b9e252f6d6bed1ddadbe5}{pull}($type = \textcolor{stringliteral}{'table'}, $name = \textcolor{stringliteral}{''}, $force = \textcolor{keyword}{false})
00140     \{
00141         $profile = $this->\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_a4bfcbf170571b61e24662b9d8bb8c95c}{\_bootstrap}();
00142 
00143         $schema = $this->\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_ae00f032a9818a3227d29bde827856256}{\_getSchema}($type, $name);
00144         \textcolor{keywordflow}{if} (!$schema->isExist()) \{
00145             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Zend\_Tool\_Project\_Provider\_Exception(
00146                 \textcolor{stringliteral}{"No \{$type\} with name '\{$name\}' found"}
00147             );
00148         \}
00149 
00150         $name = $this->\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_a7ec839cde120f748f3b0d6f24fa56d34}{\_getFilename}($type, $name);
00151 
00152         $writer = \textcolor{keyword}{new} Zend\_Config\_Writer\_Array();
00153         $writer->setConfig(\textcolor{keyword}{new} Zend\_Config($schema->toArray()));
00154 
00155         $file = $this->\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_ae23994cc878a689226c458de95a7ecd1}{createResource}($profile, $name, $writer->
      render(), $force);
00156 
00157         \textcolor{keywordflow}{if} ($this->\_registry->getRequest()->isPretend()) \{
00158             $this->\_registry->getResponse()->appendContent(
00159                 \textcolor{stringliteral}{'Would create schema at '} . $file->getPath()
00160             );
00161         \} \textcolor{keywordflow}{else} \{
00162             $this->\_registry->getResponse()->appendContent(
00163                 \textcolor{stringliteral}{'Creating schema at '} . $file->getPath()
00164             );
00165             $file->create();
00166             $this->\_storeProfile();
00167         \}
00168     \}
00169 
\hypertarget{Schema_8php_source_l00177}{}\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_aa7746bd0ed044ad415b1b7b884f7a007}{00177}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_aa7746bd0ed044ad415b1b7b884f7a007}{push}($type = \textcolor{stringliteral}{'table'}, $name = \textcolor{stringliteral}{''}, $force = \textcolor{keyword}{false})
00178     \{
00179         $profile = $this->\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_a4bfcbf170571b61e24662b9d8bb8c95c}{\_bootstrap}();
00180 
00181         $schema = $this->\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_ae00f032a9818a3227d29bde827856256}{\_getSchema}($type, $name);
00182         \textcolor{keywordflow}{if} ($schema->isExist() && !$force) \{
00183             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Zend\_Tool\_Project\_Provider\_Exception(
00184                 \textcolor{stringliteral}{"\{$type\} with name \{$name\} already exists in database. User
       force for overwrite"}
00185             );
00186         \}
00187 
00188         $name = $this->\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_a7ec839cde120f748f3b0d6f24fa56d34}{\_getFilename}($type, $name);
00189 
00190         \textcolor{keywordflow}{if} (!$file = $this->\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_a4bab978eff99970636ddf863266e9d96}{\_findfile}($profile, $name)) \{
00191             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Zend\_Tool\_Project\_Provider\_Exception(
00192                 \textcolor{stringliteral}{"Schema file '\{$name\}' is not found"}
00193             );
00194         \}
00195 
00196         $config = include $file->getPath();
00197 
00198         $schema->setFromArray($config);
00199 
00200         \textcolor{keywordflow}{if} (!$schema->isDirty()) \{
00201             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Zend\_Tool\_Project\_Provider\_Exception(
00202                 \textcolor{stringliteral}{"\{$type\} with name \{$name\} is not modified"}
00203             );
00204         \}
00205         \textcolor{keywordflow}{if} ($this->\_registry->getRequest()->isPretend()) \{
00206             $this->\_registry->getResponse()->appendContent(
00207                 \textcolor{stringliteral}{'Would exequte following sql code'} .PHP\_EOL . $schema->toSql(\textcolor{keyword}{
      true})
00208             );
00209         \} \textcolor{keywordflow}{else} \{
00210             $this->\_registry->getResponse()->appendContent(
00211                 \textcolor{stringliteral}{'Altering database'}
00212             );
00213             $schema->save();
00214             $this->\_storeProfile();
00215         \}
00216     \}
00217 
\hypertarget{Schema_8php_source_l00225}{}\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_a5741419511310dc38038399e9f4ac5e1}{00225}     \textcolor{keyword}{public} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_a5741419511310dc38038399e9f4ac5e1}{status}($type, $name)
00226     \{
00227         $profile = $this->\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_a4bfcbf170571b61e24662b9d8bb8c95c}{\_bootstrap}();
00228 
00229         $schema = $this->\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_ae00f032a9818a3227d29bde827856256}{\_getSchema}($type, $name);
00230 
00231         $name = $this->\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_a7ec839cde120f748f3b0d6f24fa56d34}{\_getFilename}($type, $name);
00232 
00233         \textcolor{keywordflow}{if} (!$file = $this->\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_a4bab978eff99970636ddf863266e9d96}{\_findfile}($profile, $name)) \{
00234             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Zend\_Tool\_Project\_Provider\_Exception(
00235                 \textcolor{stringliteral}{"Schema file '\{$name\}' is not found"}
00236             );
00237         \}
00238 
00239         $config = include $file->getPath();
00240 
00241         $schema->setFromArray($config);
00242 
00243         $status = \textcolor{stringliteral}{'Ok'};
00244         \textcolor{keywordflow}{if} ($schema->isDirty()) \{
00245             $status = \textcolor{stringliteral}{'Dirty'};
00246         \}
00247         echo $status;
00248     \}
00249 
\hypertarget{Schema_8php_source_l00257}{}\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_a7ec839cde120f748f3b0d6f24fa56d34}{00257}     \textcolor{keyword}{protected} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_a7ec839cde120f748f3b0d6f24fa56d34}{\_getFilename}($type, $name)
00258     \{
00259         \textcolor{keywordflow}{return} $name . \textcolor{charliteral}{'.'} . $type . \textcolor{stringliteral}{'.php'};
00260     \}
00261 
\hypertarget{Schema_8php_source_l00267}{}\hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_a4bfcbf170571b61e24662b9d8bb8c95c}{00267}     \textcolor{keyword}{protected} \textcolor{keyword}{function} \hyperlink{classZendDbSchema__Tool__Project__Provider__Schema_a4bfcbf170571b61e24662b9d8bb8c95c}{\_bootstrap}()
00268     \{
00269         $profile = $this->\_loadProfile(self::NO\_PROFILE\_THROW\_EXCEPTION);
00270 
00271         $bootstrapResource = $this->\_loadedProfile->search(\textcolor{stringliteral}{'BootstrapFile'});
00272 
00273         \textcolor{comment}{/* @var $zendApp Zend\_Application */}
00274         $zendApp = $bootstrapResource->getApplicationInstance();
00275 
00276         \textcolor{keywordflow}{try} \{
00277             $zendApp->bootstrap(\textcolor{stringliteral}{'db'});
00278             Zend\_Loader\_Autoloader::getInstance()->registerNamespace(\textcolor{stringliteral}{'
      ZendDbSchema'});
00279         \} \textcolor{keywordflow}{catch} (Zend\_Application\_Exception $e) \{
00280             \textcolor{keywordflow}{throw} \textcolor{keyword}{new} Zend\_Tool\_Project\_Provider\_Exception(\textcolor{stringliteral}{'Db resource not
       available, you might need to configure a DbAdapter.'});
00281             \textcolor{keywordflow}{return};
00282         \}
00283         \textcolor{keywordflow}{return} $profile;
00284     \}
00285 \}
\end{DoxyCode}
